<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Morse Micro IoT SDK: Morse M2M Protocol</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="favicon.svg" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Morse Micro IoT SDK
   &#160;<span id="projectnumber">2.6.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('group__MMAGIC__M2M__PROTOCOL.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Morse M2M Protocol<div class="ingroups"><a class="el" href="group__MMAGIC.html">MMAGIC: CLI and Machine-to-Machine interface infrastructure</a></div></div></div>
</div><!--header-->
<div class="contents">
<p >This section describes the binary protocol used by the Machine-to-Machine Interface (M2M) for communication between an Agent and a Controller. </p>
<p >The diagram below shows the roles of the Agent and Controller. The Agent connects to the Morse transceiver and implements the drivers and network stack. The Controller runs application code and controls the Agent via the M2M protocol.</p>
<div class="image">
<img src="mmagic-3chip.png" alt=""/>
<div class="caption">
Machine-to-Machine (M2M) interface for three chip solution</div></div>
 <h1><a class="anchor" id="MMAGIC_M2M_PROTOCOL_STACK"></a>
Protocol Stack</h1>
<p >The following diagram shows the M2M interface protocol software stack. At the top of the stack is the application code that runs on the Controller. This interacts with the Controller library via the <a class="el" href="group__MMAGIC__CONTROLLER.html">Morse M2M Interface Controller API</a>, which is defined in <code><a class="el" href="mmagic__controller_8h_source.html">mmagic_controller.h</a></code>. The Controller library takes care of serializing and deserializing data for communication with the Agent. It implements the controller side of the "Link Layer Control (LLC)" protocol that is responsible for multiplexing and synchronizing commands, responses, and events.</p>
<p >Actual communication between the Controller and the Agent is the responsibility of the data link layer. This layer provides a semi-reliable transport for communicating packets asychronously between the Controller and Agent. Because the data link implementation is platform and hardware dependent it needs to be implemented on a per-platform basis. Protocols are currently defined for SPI and UART transports (see <a class="el" href="group__MMAGIC__M2M__PROTOCOL.html#MMAGIC_M2M_PROTOCOL_SPI_DATALINK">M2M SPI Data Link Protocol</a> and <a class="el" href="group__MMAGIC__M2M__PROTOCOL.html#MMAGIC_M2M_PROTOCOL_UART_DATALINK">M2M UART Data Link Protocol</a> respectively). On the Controller side, the <a class="el" href="group__MMAGIC__DATALINK__CONTROLLER.html">Morse M2M Interface Controller Data Link API</a> provides the interface between the Controller library and the data link implementation.</p>
<div class="image">
<img src="mmagic-m2m-stack.drawio.png" alt=""/>
<div class="caption">
Machine-to-Machine (M2M) interface protocol stack</div></div>
 <h1><a class="anchor" id="MMAGIC_M2M_PROTOCOL_SPI_DATALINK"></a>
M2M SPI Data Link Protocol</h1>
<p >The M2M SPI Data Link protocol is asymmetric. The Controller acts as SPI master and the Agent acts as SPI slave. The protocol uses 6 pins for communication:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Pin Name   </th><th class="markdownTableHeadNone">Direction   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SPI MISO   </td><td class="markdownTableBodyNone">Agent-&gt;Controller   </td><td class="markdownTableBodyNone">SPI data: master in, slave out    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SPI MOSI   </td><td class="markdownTableBodyNone">Controller-&gt;Agent   </td><td class="markdownTableBodyNone">SPI data: master out, slave in    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SPI CLK   </td><td class="markdownTableBodyNone">Controller-&gt;Agent   </td><td class="markdownTableBodyNone">SPI clock    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SPI CS   </td><td class="markdownTableBodyNone">Controller-&gt;Agent   </td><td class="markdownTableBodyNone">SPI chip select    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Wake   </td><td class="markdownTableBodyNone">Controller-&gt;Agent   </td><td class="markdownTableBodyNone">Agent wake up    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Ready   </td><td class="markdownTableBodyNone">Agent-&gt;Controller   </td><td class="markdownTableBodyNone">Agent ready/IRQ   </td></tr>
</table>
<p >Transfers on the bus are initiated by the Controller. Two types of transfer are currently defined: packet writes and packet reads. Packet writes transfer a packet of data from Controller to Agent while packet reads transfer a packet of data from Agent to Controller.</p>
<p >Each transfer is made up of multiple SPI transactions. For each SPI transaction, the Controller first asserts the SPI CS pin, then transfers the data followed by a 16 bit CRC, then deasserts the CS pin. Each SPI transaction is half duplex (either a read or a write).</p>
<h2><a class="anchor" id="MMAGIC_M2M_PROTOCOL_SPI_DATALINK_WRITE"></a>
SPI packet write transfers</h2>
<p >A packet write transfer proceeds as follows:</p>
<ol type="1">
<li>The Controller asserts the Wake pin by driving it high.</li>
<li>The Controller polls the Ready pin until the Agent drives it high.</li>
<li>The Controller performs a SPI write transaction to write the Transfer Header (see <a class="el" href="group__MMAGIC__M2M__PROTOCOL.html#MMAGIC_M2M_PROTOCOL_SPI_DATALINK_STRUCTS">Data structures</a>) with Transfer Type set to WRITE and Length set to the length of the payload.</li>
<li>The Controller polls the Ready pin until the Agent drives it low.</li>
<li>The Controller performs a SPI write transaction to write the data packet.</li>
<li>The Controller polls the Ready pin until the Agent drives it high.</li>
<li>The Controller performs a SPI read transaction to read the Ack Trailer (see <a class="el" href="group__MMAGIC__M2M__PROTOCOL.html#MMAGIC_M2M_PROTOCOL_SPI_DATALINK_STRUCTS">Data structures</a>).</li>
<li>The Controller deasserts the Wake pin by driving it low.</li>
</ol>
<p >' Copyright 2024 Morse Micro ' SPDX-License-Identifier: Apache-2.0 </p><div class="plantumlgraph">
<img src="inline_umlgraph_5.png" />
</div>
 </p>
<h2><a class="anchor" id="MMAGIC_M2M_PROTOCOL_SPI_DATALINK_READ"></a>
SPI packet read transfers</h2>
<p >A packet read transfer proceeds as follows:</p>
<p >A read transfer proceeds as follows:</p>
<ol type="1">
<li>The Controller asserts the Wake pin by driving it high.</li>
<li>The Controller polls the Ready pin until the Agent drives it high.</li>
<li>The Controller performs a SPI write transaction to write the Transfer Header (see <a class="el" href="group__MMAGIC__M2M__PROTOCOL.html#MMAGIC_M2M_PROTOCOL_SPI_DATALINK_STRUCTS">Data structures</a>) with Transfer Type set to READ and Length set to zero.</li>
<li>The Controller polls the Ready pin until the Agent drives it low.</li>
<li>The Controller performs a SPI read transaction to read the length of the packet.</li>
<li>The Controller polls the Ready pin until the Agent drives it high.</li>
<li>The Controller performs a SPI read transaction to read the packet.</li>
<li>The Controller deasserts the Wake pin by driving it low.</li>
</ol>
<p >' Copyright 2024 Morse Micro ' SPDX-License-Identifier: Apache-2.0 </p><div class="plantumlgraph">
<img src="inline_umlgraph_6.png" />
</div>
 </p>
<h2><a class="anchor" id="MMAGIC_M2M_PROTOCOL_SPI_DATALINK_IRQ"></a>
Interrupt requests</h2>
<p >The SPI protocol is asymmetric and the Controller acts as bus master. Thus the Agent needs a means of notifying the Controller that it has a packet ready for it to read. This is done by asserting the Ready pin (driving it high) while the Wake pin is low. If the Controller detects a high level on the Ready pin while it is not asserting the Wake pin then it knows that it needs to perform a packet read transfer.</p>
<p >If the Controller performs a packet read transfer when the Agent does not have a packet buffered for read then the Agent will return a length of zero.</p>
<h2><a class="anchor" id="MMAGIC_M2M_PROTOCOL_SPI_DATALINK_STRUCTS"></a>
Data structures</h2>
<p >The <code>Transfer Header</code> is written by the Controller at the start of each transfer and comprises a one octet Transfer Type field followed by a two octet Length field. The use of these fields is defined in the sections above.</p>
<p >The <code>Ack Trailer</code> is read by the Controller at the end of a packet write transfer. It comprises a single octet indicating positive acknowledgement (CRC was valid) or negative acknowledgement (CRC or other failure).</p>
<p >The <code>Length</code> field is read during a packet read transfer and is a two octet field.</p>
<p >All multi-octet fields are little endian except the CRC, which is big endian.</p>
<h1><a class="anchor" id="MMAGIC_M2M_PROTOCOL_UART_DATALINK"></a>
M2M UART Data Link Protocol</h1>
<p >The UART-based data link protocol is asynchronous, meaning that packets can be transmitted and received at any time. This means that the protocol is symmetrical.</p>
<p >When either side has a packet queued for transmission the following protocol is observed:</p>
<ol type="1">
<li>Optionally, a CRC is calculated over the packet payload (CRC16 XModem)</li>
<li>A header octet is prepended to the packet. The current implementation of the protocol uses the most significant bit to indicate whether a CRC is present (1 = present, 0 = absent). The remainder of the bits are reserved and must be set to zero.</li>
<li>The packet is encoded using the SLIP encoding and is transmitted via the UART.</li>
</ol>
<p >Packet reception mirrors transmission.</p>
<p >For an example implementation see <code>mmagic/agent/m2m_datalink/mmagic_datalink_uart.c</code>. This data link can be enabled when using the <a class="el" href="cli_8c.html">cli.c</a> examaple application by setting the <a class="el" href="group__MMCONFIG.html">Morse Micro Persistent Configuration Store</a> variable <code>cli.mode</code> to <code>m2m</code>.</p>
<h1><a class="anchor" id="MMAGIC_M2M_PROTOCOL_PACKETS"></a>
M2M Packet Structure</h1>
<p >The following diagram shows the structure of M2M packets, excluding data link layer framing.</p>
<div class="image">
<img src="mmagic-m2m-packet.drawio.png" alt=""/>
<div class="caption">
Machine-to-Machine (M2M) interface packet structure</div></div>
 <p >Since both sides of the protocol are implemented by the MMAGIC Agent and Controller libraries, details of these protocol layers are not documented here. </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Copyright 2021 Morse Micro </li>
  </ul>
</div>
</body>
</html>
