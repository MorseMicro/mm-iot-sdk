<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Morse Micro IoT SDK: aws_iot.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="favicon.svg" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Morse Micro IoT SDK
   &#160;<span id="projectnumber">2.6.4</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('aws__iot_8c.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle"><div class="title">aws_iot.c File Reference</div></div>
</div><!--header-->
<div class="contents">
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p >AWS IoT example to demonstrate connecting to AWS Shadow service and demonstrate a simple light bulb example. </p>
<dl class="section note"><dt>Note</dt><dd>It is assumed that you have followed the steps in the <a class="el" href="GETTING_STARTED.html">Getting Started</a> guide and are therefore familiar with how to build, flash, and monitor an application using the MM-IoT-SDK framework.</dd></dl>
<p>This example application demonstrates how to use AWS IoT Core services to connect to an AWS endpoint and use the shadow service to mirror the state of a light bulb shadow state maintained by AWS.</p>
<h1><a class="anchor" id="AWS_GETTING_STARTED"></a>
Getting Started</h1>
<p >The following steps need to be done to run this application:</p>
<h2><a class="anchor" id="autotoc_md0"></a>
Sign in to the AWS IoT console</h2>
<ul>
<li>Go to <a href="https://aws.amazon.com/">https://aws.amazon.com/</a> and click <em>Sign in</em> on the top right corner. If you don't already have an Amazon/AWS account, create one or contact your company IT department to create a company account for you.</li>
<li>From the services menu on the top left select <em>Internet of Things &gt; IoT Core</em></li>
</ul>
<h2><a class="anchor" id="CREATE_THING"></a>
Create a Thing</h2>
<ul>
<li>On the left hand menu select <em>Manage &gt; All Devices &gt; Things</em></li>
<li>Click <em>Create things</em></li>
<li>Select <em>Create single thing</em></li>
<li>Click <em>Next</em></li>
<li>Enter a Thing name. You will need to remember this for name later.</li>
<li>Select <em>Unnamed shadow (classic)</em></li>
<li>Enter the following as shadow statement: <div class="fragment"><div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;state&quot;</span>: {</div>
<div class="line">        <span class="stringliteral">&quot;reported&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;powerOn&quot;</span>: 0</div>
<div class="line">        },</div>
<div class="line">        <span class="stringliteral">&quot;desired&quot;</span>: {</div>
<div class="line">            <span class="stringliteral">&quot;powerOn&quot;</span>: 0</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Click <em>Next</em></li>
<li>Select <em>Auto generate new certificates</em></li>
<li>Click <em>Next</em>.</li>
<li>Now create an "Allow All" policy if you do not already have one (you only need to do this once).<ul>
<li>Click <em>Create Policy</em> (this will open a new tab)</li>
<li>Enter a policy name such as <code>AllowAll</code> </li>
<li>In the <em>Builder</em> tab, in <em>Policy document</em> enter the following data: <div class="fragment"><div class="line">Policy effect:   Allow</div>
<div class="line">Policy action:   *</div>
<div class="line">Policy resource: *</div>
</div><!-- fragment --></li>
<li>Click <em>Create</em>.</li>
<li>Return to the <em>Attach policies to certificate</em> tab in your browser</li>
</ul>
</li>
<li>Ensure the <code>AllowAll</code> policy is selected</li>
<li>Click <em>Create thing</em></li>
</ul>
<p >Congratulations! Your device should now be created.</p>
<p >Download the certificates and key files and proceed to the next step. Specifically you will need the Device Certificate, Device Private Key amd the Amazon <em>RSA</em> Root Certificate.</p>
<dl class="section note"><dt>Note</dt><dd>You can also create the Allow All policy on the AWS CLI using the following command: <div class="fragment"><div class="line">aws iot create-policy \</div>
<div class="line">   --policy-name=<span class="stringliteral">&quot;AllowAllDev&quot;</span> \</div>
<div class="line">   --policy-document=<span class="stringliteral">&quot;{ \&quot;Version\&quot;: \&quot;1\&quot;, \</span></div>
<div class="line"><span class="stringliteral">                        \&quot;Statement\&quot;: [{ \</span></div>
<div class="line"><span class="stringliteral">                             \&quot;Effect\&quot;: \&quot;Allow\&quot;, \</span></div>
<div class="line"><span class="stringliteral">                             \&quot;Action\&quot;: \&quot;iot:*\&quot;, \</span></div>
<div class="line"><span class="stringliteral">                             \&quot;Resource\&quot;: \&quot;*\&quot; \</span></div>
<div class="line"><span class="stringliteral">                      }]}&quot;</span></div>
</div><!-- fragment --> Likewise, you can create all certificates in the AWS CLI. You may also use third party tools like <code>openssh</code> to create the device certificate and keys and upload them using AWS CLI.</dd>
<dd>
We show creating certificates for a single thing using the AWS IoT console as this is the easiest way to test the application. This is however not a practical way to provision devices in the field. For production we recommend Just In Time Provisioning as documented here <code><a href="https://docs.aws.amazon.com/iot/latest/developerguide/jit-provisioning.html">https://docs.aws.amazon.com/iot/latest/developerguide/jit-provisioning.html</a></code> This method loads all devices with a common provisioning certificate, which then gets replaced with a unique device certificate when the device first connects to the AWS endpoint.</dd></dl>
<h2><a class="anchor" id="INSTALL_CREDENTIALS"></a>
Install device certificates and keys</h2>
<ul>
<li>In the credentials directory replace the files <code>AmazonRootCA.pem</code>, <code>certificate.pem.crt</code>, and <code>private.pem.key</code> with the files downloaded from AWS in the previous step. Rename the downloaded files to match the target file names. Note: Amazon provides you with 2 root CA files to download, please use the file named <code>AmazonRootCA1.pem</code>.</li>
<li>Open the <code>config.hjson</code> file.<ul>
<li>Update the value of <code>aws.thingname</code> with the name of the thing you created in the previous section.</li>
<li>Now, in AWS IoT console, navigate to Manage &gt; All Devices &gt; Things<ul>
<li>Click on the thing you just created and then click on the "Device Shadows" tab.</li>
<li>Click on the "Classic Shadow". Then look at the "Device Shadow URL" in the "Device Shadow details" panel.</li>
<li>Update the value of <code>aws.endpoint</code> with the server name in the URL. Ensure you remove the <code><a href="https://">https://</a></code> and everything after <code>amazonaws.com</code> <ul>
<li>Alternatively, you can get the endpoint from the AWS CLI by typing in the following command: <div class="fragment"><div class="line">aws iot describe-endpoint</div>
</div><!-- fragment --></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Follow the <a class="el" href="group__MMCONFIG.html#MMCONFIG_PROGRAMMING">Programming the config store from a host PC</a> instructions to load the <code>config.hjson</code> file to the device. <dl class="section note"><dt>Note</dt><dd>The default config store key names are defined in <a class="el" href="aws__iot__config_8h.html">aws_iot_config.h</a>. You may change these names as required for your application.</dd></dl>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md1"></a>
Running the application</h2>
<ul>
<li>Now build and run the application.</li>
<li>You should see the device connect to AWS IoT.<ul>
<li>If you see connection failures ensure your access point forwards traffic to the Internet.</li>
</ul>
</li>
<li>Once the device is connected look for the state of the <code>powerOn</code> variable.<ul>
<li>Initially it should be 0 signifying the lamp is OFF - in the ST Nucleo boards this is represented by the Blue LED which should be OFF.</li>
</ul>
</li>
<li>Now Open the AWS IoT console and click on the "MQTT Test client" from the left hand side menu.<ul>
<li>Click on "Publish to a Topic" tab and enter the following topic: <div class="fragment"><div class="line">$aws/things/&lt;your_thing_name&gt;/shadow/update</div>
</div><!-- fragment --> Naturally, replace <code>"&lt;your_thing_name&gt;"</code> with the name of the thing you created.</li>
<li>Enter the following JSON text in the "Message payload" section and click "Publish". <div class="fragment"><div class="line">{</div>
<div class="line">   <span class="stringliteral">&quot;state&quot;</span>: {</div>
<div class="line">       <span class="stringliteral">&quot;desired&quot;</span>: {</div>
<div class="line">          <span class="stringliteral">&quot;powerOn&quot;</span>: 1</div>
<div class="line">       }</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>You should now see the LED turn ON and the value of <code>powerOn</code> parameter printed on the console output should change.</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
What is AWS Shadow?</h1>
<p >AWS Shadow service allows us to cache the state of an IoT device on the cloud. This allows the IoT device to go to sleep and wake up once in a while to update its state on the cloud and act on pending state change requests on the cloud. For example a temperature sensor could periodically measure and update the temperature using the AWS Shadow service and go to sleep for minutes or even hours at a time while AWS Shadow caches this data and makes it available persistently to anyone who may be interested in the temperature even though the sensor is asleep and no longer reachable on the network.</p>
<p >Likewise, for a light bulb, AWS Shadow remembers the state of the light bulb even though the light bulb itself may have been unplugged and so not connected to the network. In fact the AWS Shadow can accept state change requests on behalf of the light bulb when it is unplugged and then convey the desired state to the light bulb when it connects again.</p>
<p >This is how it works:</p>
<ul>
<li>A device such as a light switch that desires to change the state of the light bulb publishes a message to the topic <code>"$aws/things/&lt;your_thing_name&gt;/shadow/update"</code> <div class="fragment"><div class="line">{</div>
<div class="line">   <span class="stringliteral">&quot;state&quot;</span>: {</div>
<div class="line">       <span class="stringliteral">&quot;desired&quot;</span>: {</div>
<div class="line">          <span class="stringliteral">&quot;powerOn&quot;</span>: 1</div>
<div class="line">       }</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>If this is a change in state, then AWS Shadow will post a delta message to <code>"$aws/things/&lt;your_thing_name&gt;/shadow/update/delta"</code> as <div class="fragment"><div class="line">{</div>
<div class="line">   <span class="stringliteral">&quot;state&quot;</span>: {</div>
<div class="line">      <span class="stringliteral">&quot;powerOn&quot;</span>: 1</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --><ul>
<li>If the device is unplugged, then AWS Shadow will automatically send this message with the latest state when the device comes online next.</li>
</ul>
</li>
<li>Once the device receives this delta message and acts on it, it will then report its new state by publishing to: <code>"$aws/things/&lt;your_thing_name&gt;/shadow/update"</code> <div class="fragment"><div class="line">{</div>
<div class="line">   <span class="stringliteral">&quot;state&quot;</span>: {</div>
<div class="line">       <span class="stringliteral">&quot;reported&quot;</span>: {</div>
<div class="line">          <span class="stringliteral">&quot;powerOn&quot;</span>: 1</div>
<div class="line">       }</div>
<div class="line">   }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>If the state change was accepted, AWS Shadow will forward the above message to: <code>"$aws/things/&lt;your_thing_name&gt;/shadow/update/accepted"</code> </li>
<li>If for some reason, the state change request was rejected by the device, then AWS Shadow will publish to <code>"$aws/things/&lt;your_thing_name&gt;/shadow/update/rejected"</code> </li>
</ul>
<p >For more information see: <code><a href="https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html">https://docs.aws.amazon.com/iot/latest/developerguide/iot-device-shadows.html</a></code> </p>
<h1><a class="anchor" id="autotoc_md3"></a>
Integrating with Alexa</h1>
<p >Now that we have seen AWS Shadow being used to connect to and control our IoT device, how can we put this to practice with a real world application?</p>
<p >Amazon shows us how we can use Alexa to post messages to AWS IoT devices with an example smart hotel application: <code><a href="https://aws.amazon.com/blogs/iot/implement-a-connected-building-with-alexa-and-aws-iot/">https://aws.amazon.com/blogs/iot/implement-a-connected-building-with-alexa-and-aws-iot/</a></code> </p>
<p >In this example they show us how to create an Alexa skill that can post JSON messages to our IoT device using AWS Shadow. You can use the tutorial above to customize this application for your specific smart device needs.</p>
<h1><a class="anchor" id="autotoc_md4"></a>
Automation and Production</h1>
<p >In the example above we used the AWS IoT console to create certificates and publish/subscribe to MQTT messages. While this may be convenient for development and testing, it is hardly a practical approach for real world applications. Luckily, we have options - Amazon provides us with the AWS CLI (Command Line Interface), which lets us do everything above using a command line interface such as creating certificates, registering devices, publishing and subscribing to MQTT messages. This allows us to automate and script production and registration of devices and even implement M2M communications using the MQTT publish/subscribe API. A full reference of the available commands is at: <code><a href="https://docs.aws.amazon.com/cli/latest/index.html">https://docs.aws.amazon.com/cli/latest/index.html</a></code> </p>
<h1><a class="anchor" id="autotoc_md5"></a>
OTA Updates</h1>
<p >This application supports Over The Air updates. OTA updates can be used to update the existing application on the IoT device with newer versions of itself. For OTA updates to work, there must be a bootloader installed and an existing version of the application that is able to connect to the AWS IoT infrastructure.</p>
<p >To perform an OTA update, first ensure there is a version of this application running on the device with the right credentials and certificates to connect to the service. In addition to certificates and keys described in step 3 of the Getting Started section above, we will also need a code signing certificate to be installed on the device. This certificate can be generated using a tool like openssl as described below:</p>
<dl class="section note"><dt>Note</dt><dd>OTA update feature is supported only on <code>mm-ekh08-u575</code> and <code>mm-mm6108-ekh05</code> platforms - you will get an error on all other platforms if you attempt an OTA update. To add OTA support to your platform, you will need to:<ul>
<li>Build and install the bootloader for your platform. (See <a class="el" href="bootloader_8c.html">bootloader.c</a>) If you are loading the application using <code>openocd</code>, then <em>first</em> load the application and then load the bootloader. Do this every time you load the application using openocd as the application contains a stub bootloader that will overwrite the real bootloader.</li>
<li>Ensure you have enabled flash file-system support for your platform. To add flash file-system support for your platform, you will need to add a <code></code>.filesystem section to your linker definition file that is big enough to accommodate the OTA download image plus any other data you may store in the file-system. Also ensure you have a valid implementation of <a class="el" href="group__MMHAL.html#ga9cf859409f0916684a34f5d4726cb2e3">mmhal_get_littlefs_config()</a> that returns your file-system configuration.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="autotoc_md6"></a>
Generating Code Signing Keys</h2>
<h3><a class="anchor" id="autotoc_md7"></a>
Option 1: Generating @c ECDSA Keys for signing by AWS</h3>
<p >The steps below are from the following document: <code><a href="https://docs.aws.amazon.com/freertos/latest/userguide/ota-code-sign-cert-win.html">https://docs.aws.amazon.com/freertos/latest/userguide/ota-code-sign-cert-win.html</a></code> </p><ul>
<li>In your working directory, create a file named <code>cert_config.txt</code> with the following text: <div class="fragment"><div class="line">[ req ]</div>
<div class="line">prompt             = no</div>
<div class="line">distinguished_name = my_dn</div>
<div class="line">[ my_dn ]</div>
<div class="line">commonName = me@myemail.com</div>
<div class="line">[ my_exts ]</div>
<div class="line">keyUsage         = digitalSignature</div>
<div class="line">extendedKeyUsage = codeSigning</div>
</div><!-- fragment --> Replace <code><a href="#" onclick="location.href='mai'+'lto:'+'me@'+'my'+'ema'+'il'+'.co'+'m'; return false;">me@my<span class="obfuscator">.nosp@m.</span>emai<span class="obfuscator">.nosp@m.</span>l.com</a></code> with your organization email and replace the my in <code>my_dn</code> and <code>my_exts</code> with your organization name as appropriate.</li>
<li>Create an <code>ECDSA</code> code-signing private key: <div class="fragment"><div class="line">openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:P-256 -pkeyopt ec_param_enc:named_curve -outform PEM -out otasigning.key</div>
</div><!-- fragment --></li>
<li>Create an <code>ECDSA</code> code-signing certificate: <div class="fragment"><div class="line">openssl req -<span class="keyword">new</span> -x509 -config cert_config.txt -extensions my_exts -nodes -days 365 -key otasigning.key -out otasigning.pem.crt</div>
</div><!-- fragment --></li>
<li>Copy the <code>otasigning.pem.crt</code> file to the credentials folder and follow the <a class="el" href="group__MMCONFIG.html#MMCONFIG_PROGRAMMING">Programming the config store from a host PC</a> instructions to load the <code>config.hjson</code> file to the device. Ensure you have generated the other certificates, keys and provisioning information as described in <a class="el" href="aws__iot_8c.html#AWS_GETTING_STARTED">Getting Started</a> section above.</li>
</ul>
<h3><a class="anchor" id="autotoc_md8"></a>
Option 2: Generating Self signing (RSA) keys</h3>
<ul>
<li>Create the signing keys &amp; certificate as shown below: <div class="fragment"><div class="line">openssl genrsa -out otasigning.key 2048</div>
<div class="line">openssl rsa -in otasigning.key -pubout otasigning.pem.crt</div>
</div><!-- fragment --></li>
<li>Copy the <code>otasigning.pem.crt</code> file to the credentials folder and follow the <a class="el" href="group__MMCONFIG.html#MMCONFIG_PROGRAMMING">Programming the config store from a host PC</a> instructions to load the <code>config.hjson</code> file to the device. Ensure you have generated the other certificates, keys and provisioning information as described in <a class="el" href="aws__iot_8c.html#AWS_GETTING_STARTED">Getting Started</a> section above.</li>
<li>Sign the code<ul>
<li>Build the update file for the application, you should get a .mbin file in the output directory <div class="fragment"><div class="line">make mbin -j4</div>
</div><!-- fragment --></li>
<li>Sign the .mbin file as shown below <div class="fragment"><div class="line">openssl dgst -sha256 -sign otasigning.key -out signature.bin &lt;MBIN file&gt;</div>
<div class="line">openssl enc -base64 -in signature.bin -out signature.txt</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Upload the MBIN file to AWS as described below, paste the contents of the <code>signature.txt</code> file into the signature field</li>
</ul>
<h2><a class="anchor" id="autotoc_md9"></a>
Deploying the update</h2>
<ul>
<li>First, ensure your AWS account has the required permissions. For more information, see: <code><a href="https://docs.aws.amazon.com/freertos/latest/userguide/code-sign-policy.html">https://docs.aws.amazon.com/freertos/latest/userguide/code-sign-policy.html</a></code> </li>
<li>In the AWS IoT Core portal, select Manage &gt; Remote Actions &gt; Jobs, then click Create job.</li>
<li>Under Job type select Create FreeRTOS OTA update job, then choose Next.</li>
<li>Enter a name for the job and click Next.</li>
<li>Under Devices to update, choose one or more things or thing groups from the drop down menu.</li>
<li>Select <code>MQTT</code> for file transfer protocol.</li>
<li>Under Sign and choose your file, select Sign a new file for me.</li>
<li>If you are using Option 2 (Self signed image), then select Use My custom signed file<ul>
<li>Cut and paste the contents of the <code>signature.txt</code> file that you generated while signing into the signature box.</li>
<li>Select SHA-256 as the original hash algorithm.</li>
<li>Select RSA as the original encryption algorithm.</li>
<li>Enter <code>aws.ota_cert</code> as the path name of the code signing certificate on the device. (This incidentally is the name of the config store key that contains the certificate)</li>
<li>Click Upload a new file and upload the .mbin file.</li>
<li>If you have not already done so, create an S3 bucket and specify the path to save the file as.</li>
<li>In path name of the file on the device enter the name of the mbin file. Ensure this is a valid file name or the update will fail.</li>
<li>Select an <code>IAM</code> role with permissions to do OTA updates and click Next.</li>
<li>In the next screen click Create Job.</li>
</ul>
</li>
<li>If you are using Option 1 (Signing by AWS)<ul>
<li>If you have not already done so, under Code signing profile, choose Create new profile.<ul>
<li>In Create a code signing profile, enter a name for your code-signing profile.</li>
<li>Under Device hardware platform choose Windows Simulator. You will need to get your platform certified by AWS for it to appear here.</li>
<li>Select Import a new code signing certificate.</li>
<li>Upload <code>otasigning.pem.crt</code> as the certificate body.</li>
<li>Upload <code>otasigning.key</code> as the certificate private key.</li>
<li>Click import.</li>
<li>Enter <code>aws.ota_cert</code> as the path name of the code signing certificate on the device.</li>
<li>Click Create.</li>
</ul>
</li>
<li>Back at the previous screen, select the code signing profile you just created.</li>
<li>Click Upload a new file and upload the .mbin file.</li>
<li>If you have not already done so, create an S3 bucket and specify the path to save the file as.</li>
<li>In path name of the file on the device enter the name of the mbin file. Ensure this is a valid file name or the update will fail.</li>
<li>Select an <code>IAM</code> role with permissions to do OTA updates and click Next.</li>
<li>In the next screen click Create Job.</li>
</ul>
</li>
</ul>
<p >Congratulations! The update has been deployed. If the application is currently running on the device, it should immediately see the update and start downloading it. In a minute or two the device should reboot and the new update will be applied. AWS will indicate successful update on the console once the updated firmware boots and connects to AWS.</p>
<dl class="section note"><dt>Note</dt><dd>If the above process does not work for you, then you can debug the issue by enabling OTA logging by removing the <code>DISABLE_OTA_LOGGING</code> flag from the <code>Makefile</code> and <code>platformio.ini</code> files for this example. Also, ensure you increment the version numbers in <code><a class="el" href="version_8h.html" title="Contains the software version used for OTA update.">version.h</a></code> prior to every OTA update or you will get warnings that the new version is not higher than the old version, the update will still complete though.</dd></dl>
<p>For more information, see: <code><a href="https://docs.aws.amazon.com/freertos/latest/userguide/ota-console-workflow.html">https://docs.aws.amazon.com/freertos/latest/userguide/ota-console-workflow.html</a></code> </p>
<h1><a class="anchor" id="autotoc_md10"></a>
Fleet Provisioning</h1>
<p >The steps above describe how to provision one device at a time for AWS IoT. This however is not practical when we have to provision thousands of devices in the field. Thankfully AWS provides a mechanism called Fleet Provisioning that allows us to automate this process.</p>
<p >For more information on Fleet Provisioning see: <code><a href="https://docs.aws.amazon.com/whitepapers/latest/device-manufacturing-provisioning/provisioning-identity-in-aws-iot-core-for-device-connections.html">https://docs.aws.amazon.com/whitepapers/latest/device-manufacturing-provisioning/provisioning-identity-in-aws-iot-core-for-device-connections.html</a></code> </p>
<p >There are multiple mechanisms of implementing Fleet Provisioning - we have implemented the <em>Fleet Provisioning by claim</em> mechanism. In this mechanism a batch of devices (say 1000) will be loaded with a shared claim certificate and keys. The device will make first contact with the AWS endpoint using this shared certificate and key just as it would with regular device certificates and keys. The device then generates a new set of keys and sends the certificate to AWS for signing. AWS signs the certificate and assigns the device a new thing name based on the provisioning template - the provisioning template may specify the thing name is an amalgam of the device serial number (in our case the MAC address) and some prefix. The device saves the signed certificate, generated keys and thing name and uses them for all connections henceforth.</p>
<p >Use the steps below to implement fleet provisioning. Alternatively, if you prefer to use the AWS command line, then all the steps below are described here for the command line: <code><a href="https://www.freertos.org/iot-fleet-provisioning/demo.html#setting-up">https://www.freertos.org/iot-fleet-provisioning/demo.html#setting-up</a></code> </p>
<h2><a class="anchor" id="autotoc_md11"></a>
Prerequisites</h2>
<p >Ensure you have the required permissions and roles to implement fleet provisioning. Your AWS administrator can setup the roles using the following commands on the AWS command line:</p><ul>
<li>Create <code>FleetProvisioningRole</code> role <div class="fragment"><div class="line">aws iam create-role --role-name <span class="stringliteral">&quot;FleetProvisioningRole&quot;</span> --assume-role-policy-document \</div>
<div class="line">    <span class="stringliteral">&#39;{&quot;Version&quot;:&quot;2012-10-17&quot;,&quot;Statement&quot;:[{&quot;Action&quot;:&quot;sts:AssumeRole&quot;,&quot;Effect&quot;:&quot;Allow&quot;, \</span></div>
<div class="line"><span class="stringliteral">    &quot;Principal&quot;:{&quot;Service&quot;:&quot;iot.amazonaws.com&quot;}}]}&#39;</span></div>
</div><!-- fragment --></li>
<li>Attach <code>AWSIoTThingsRegistration</code> policy to the role <div class="fragment"><div class="line">aws iam attach-role-policy --role-name <span class="stringliteral">&quot;FleetProvisioningDemoRole&quot;</span> \</div>
<div class="line">    --policy-arn arn:aws:iam::aws:policy/service-role/AWSIoTThingsRegistration</div>
</div><!-- fragment --></li>
<li>Create the <code>AllowAll</code> policy as described in <a class="el" href="aws__iot_8c.html#CREATE_THING">Create a Thing</a></li>
</ul>
<h2><a class="anchor" id="CREATE_THING_TYPE"></a>
Create a thing type</h2>
<ul>
<li>Open the AWS IoT console web page.</li>
<li>Go to <em>Manage &gt; All Devices &gt; Thing types</em></li>
<li>Click <em>Create thing type</em></li>
<li>For this example, enter <code>_fp_demo_things_</code> and click <em>Create thing type</em></li>
<li>If you change the name remember to update it in the JSON file in the step below.</li>
</ul>
<h2><a class="anchor" id="CREATE_CLAIM_POLICY"></a>
Create a claim policy</h2>
<ul>
<li>On the AWS IoT console go to <em>Manage &gt; Security &gt; Policies</em></li>
<li>Click <em>Create policy</em> and give it a suitable name</li>
<li>In the <em>Policy document</em> section, click JSON and enter the code below (which can also be found in <code>templates/fleet_provisioning_policy.json</code>): <div class="fragment"><div class="line">{</div>
<div class="line">    &quot;Version&quot;: &quot;2012-10-17&quot;,</div>
<div class="line">    &quot;Statement&quot;: [</div>
<div class="line">      {</div>
<div class="line">        &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">        &quot;Action&quot;: [</div>
<div class="line">          &quot;iot:Connect&quot;</div>
<div class="line">        ],</div>
<div class="line">        &quot;Resource&quot;: &quot;*&quot;</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">        &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">        &quot;Action&quot;: [</div>
<div class="line">          &quot;iot:Publish&quot;,</div>
<div class="line">          &quot;iot:Receive&quot;</div>
<div class="line">        ],</div>
<div class="line">        &quot;Resource&quot;: [</div>
<div class="line">          &quot;arn:aws:iot:&lt;AWS-REGION&gt;:&lt;AWS-ACCOUNT-ID&gt;:topic/$aws/certificates/create-from-csr/*&quot;,</div>
<div class="line">          &quot;arn:aws:iot:&lt;AWS-REGION&gt;:&lt;AWS-ACCOUNT-ID&gt;:topic/$aws/provisioning-templates/FleetProvisioningTemplate/provision/*&quot;</div>
<div class="line">        ]</div>
<div class="line">      },</div>
<div class="line">      {</div>
<div class="line">        &quot;Effect&quot;: &quot;Allow&quot;,</div>
<div class="line">        &quot;Action&quot;: &quot;iot:Subscribe&quot;,</div>
<div class="line">        &quot;Resource&quot;: [</div>
<div class="line">          &quot;arn:aws:iot:&lt;AWS-REGION&gt;:&lt;AWS-ACCOUNT-ID&gt;:topicfilter/$aws/certificates/create-from-csr/*&quot;,</div>
<div class="line">          &quot;arn:aws:iot:&lt;AWS-REGION&gt;:&lt;AWS-ACCOUNT-ID&gt;:topicfilter/$aws/provisioning-templates/FleetProvisioningTemplate/provision/*&quot;</div>
<div class="line">        ]</div>
<div class="line">      }</div>
<div class="line">    ]</div>
<div class="line">  }</div>
</div><!-- fragment --> Replace &lt;aws-region&gt; and &lt;aws-account-id&gt; as appropriate for your AWS account. Ensure you replace <code>_FleetProvisioningTemplate_</code> with the name of the template you specified in <a class="el" href="aws__iot_8c.html#CREATE_PROV_TEMPLATE">Create provisioning template</a>. Set the <code>aws.provisioningtemplate</code> key to the provisioning template name you specified here.</li>
</ul>
<h2><a class="anchor" id="CREATE_PROV_TEMPLATE"></a>
Create provisioning template</h2>
<ul>
<li>On the AWS IoT console go to <em>Connect &gt; Connect many devices &gt; Connect many devices</em></li>
<li>Click <em>Create provisioning template</em></li>
<li>Select <em>Provisioning devices with claim certificate</em> then click <em>Next</em></li>
<li>Select <em>Active</em>, then enter a template name such as <code>_FleetProvisioningTemplate_</code> </li>
<li>Select the provisioning role you created in the prerequisites step above. Ensure _Attach managed policy to <code>IAM</code> role_ is unchecked.</li>
<li>Under <em>Claim certificate policy</em> select the claim certificate you created in above, Then click <em>Next</em>.</li>
<li>In the next page select <em>Don't use a pre-provisioning action</em>, then click <em>Next</em>.</li>
<li>In the next page click <em>Next</em>.</li>
<li>Finally click <em>Create template</em></li>
<li>Then click on the newly created template, then click <em>Edit JSON</em> in the document section below. Enter the following JSON (which can also be found in <code>templates/fleet_provisioning_template.json</code>): <div class="fragment"><div class="line">{</div>
<div class="line">    &quot;Parameters&quot;: {</div>
<div class="line">      &quot;SerialNumber&quot;: {</div>
<div class="line">        &quot;Type&quot;: &quot;String&quot;</div>
<div class="line">      },</div>
<div class="line">      &quot;AWS::IoT::Certificate::Id&quot;: {</div>
<div class="line">        &quot;Type&quot;: &quot;String&quot;</div>
<div class="line">      }</div>
<div class="line">    },</div>
<div class="line">    &quot;Resources&quot;: {</div>
<div class="line">      &quot;certificate&quot;: {</div>
<div class="line">        &quot;Properties&quot;: {</div>
<div class="line">          &quot;CertificateId&quot;: {</div>
<div class="line">            &quot;Ref&quot;: &quot;AWS::IoT::Certificate::Id&quot;</div>
<div class="line">          },</div>
<div class="line">          &quot;Status&quot;: &quot;Active&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Type&quot;: &quot;AWS::IoT::Certificate&quot;</div>
<div class="line">      },</div>
<div class="line">      &quot;policy&quot;: {</div>
<div class="line">        &quot;Properties&quot;: {</div>
<div class="line">          &quot;PolicyName&quot;: &quot;AllowAll&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Type&quot;: &quot;AWS::IoT::Policy&quot;</div>
<div class="line">      },</div>
<div class="line">      &quot;thing&quot;: {</div>
<div class="line">        &quot;OverrideSettings&quot;: {</div>
<div class="line">          &quot;AttributePayload&quot;: &quot;MERGE&quot;,</div>
<div class="line">          &quot;ThingGroups&quot;: &quot;DO_NOTHING&quot;,</div>
<div class="line">          &quot;ThingTypeName&quot;: &quot;REPLACE&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Properties&quot;: {</div>
<div class="line">          &quot;AttributePayload&quot;: {},</div>
<div class="line">          &quot;ThingGroups&quot;: [],</div>
<div class="line">          &quot;ThingName&quot;: {</div>
<div class="line">            &quot;Fn::Join&quot;: [</div>
<div class="line">              &quot;&quot;,</div>
<div class="line">              [</div>
<div class="line">                &quot;fp_demo_&quot;,</div>
<div class="line">                {</div>
<div class="line">                  &quot;Ref&quot;: &quot;SerialNumber&quot;</div>
<div class="line">                }</div>
<div class="line">              ]</div>
<div class="line">            ]</div>
<div class="line">          },</div>
<div class="line">          &quot;ThingTypeName&quot;: &quot;fp_demo_things&quot;</div>
<div class="line">        },</div>
<div class="line">        &quot;Type&quot;: &quot;AWS::IoT::Thing&quot;</div>
<div class="line">      }</div>
<div class="line">    },</div>
<div class="line">    &quot;DeviceConfiguration&quot;: {</div>
<div class="line">        &quot;Foo&quot;: &quot;Bar&quot;</div>
<div class="line">    }</div>
<div class="line">  }</div>
</div><!-- fragment --> Ensure <code>_AllowAll_</code> matches the name of the <code>AllowAll</code> policy you created in the prerequisites. Ensure <code>_fp_demo_things_</code> matches the thing type you created in <a class="el" href="aws__iot_8c.html#CREATE_THING_TYPE">Create a thing type</a></li>
<li>Click <em>Save as new version</em></li>
</ul>
<h2><a class="anchor" id="autotoc_md12"></a>
Generate claim certificates and keys</h2>
<ul>
<li>On the AWS IoT console go to <em>Manage &gt; Security &gt; Certificates</em></li>
<li>Click Add Certificate &gt; Create Certificate</li>
<li>On the next page download the private key, certificate and the root certificate.</li>
<li>Use this certificate and key as the claim certificate for a batch of devices. You may create multiple certificates here, one for each batch.</li>
<li>Select the certificate(s) you just created then click <em>Attach policy</em> and attach the claim policy you created earlier to all the claim certificates you generated now.</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Setting up the device</h2>
<ul>
<li>Once the above steps are done, load the claim certificate, private key and root certificate as described in <a class="el" href="aws__iot_8c.html#INSTALL_CREDENTIALS">Install device certificates and keys</a>. The device will use these credentials for the initial connection and will be replaced by device certificate and keys provided by AWS when provisioning has successfully completed.</li>
<li>Set the <code>aws.provisioningtemplate</code> key to the provisioning template name you set in <a class="el" href="aws__iot_8c.html#CREATE_PROV_TEMPLATE">Create provisioning template</a>.</li>
<li>Ensure the device has the necessary <code>Wi-Fi</code> credentials and country code.</li>
<li>Power cycle the device, it should connect to AWS with the provided claim certificate. AWS will then sign the new certificate generated by the device and provide it with a Thing Name that the device will write to <code>aws.thingname</code> and atomically replace the claim credentials with the newly generated credentials.</li>
<li>After reboot the device will connect with the newly assigned credentials and commence normal operation.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If you want to provision the same device a second time, remember to delete the device from <em>Manage &gt; All devices &gt; Things</em>. Also note that the device overwrites the claim certificate and keys, so there are several options should you require to re-provision (for example if adding factory reset support):<ul>
<li>The application keeps a copy of the claim certificate and keys, then restores them on a factory reset and deletes the <code>aws.thingname</code> key. However, be aware that claim certificates are intended to be used temporarily and may expire or be revoked. So this method of re-provisioning may fail if the claim certificate is no longer valid.</li>
<li>The application uses the existing device certificates as claim certificates to re-provision, provided the device policy includes permissions for the <code>create-from-csr</code> and <code>provisioning-templates</code> resources. In our case the <code>AllowAll</code> policy allows everything including these claim permissions. To re-provision, the application simply deletes the <code>aws.thingname</code> key to trigger the provisioning process. This method has the advantage of requiring less resources by not needing to keep a copy of the claim certificate and key which saves around 3KB of storage in persistent store. </li>
</ul>
</dd></dl>

<p class="definition">Definition in file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>
</div><div class="textblock"><code>#include &lt;string.h&gt;</code><br />
<code>#include &quot;mmhal.h&quot;</code><br />
<code>#include &quot;mmosal.h&quot;</code><br />
<code>#include &quot;mmwlan.h&quot;</code><br />
<code>#include &quot;mmconfig.h&quot;</code><br />
<code>#include &quot;mm_app_loadconfig.h&quot;</code><br />
<code>#include &quot;mmipal.h&quot;</code><br />
<code>#include &quot;mqtt_agent_task.h&quot;</code><br />
<code>#include &quot;sntp_client.h&quot;</code><br />
<code>#include &quot;core_json.h&quot;</code><br />
<code>#include &quot;mm_app_common.h&quot;</code><br />
<code>#include &quot;<a class="el" href="aws__iot__config_8h_source.html">aws_iot_config.h</a>&quot;</code><br />
</div><div class="textblock"><div class="dynheader">
Include dependency graph for aws_iot.c:</div>
<div class="dyncontent">
<div class="center"><img src="aws__iot_8c__incl.png" border="0" usemap="#aaws__iot_8c" alt=""/></div>
<map name="aaws__iot_8c" id="aaws__iot_8c">
<area shape="rect" title="AWS IoT example to demonstrate connecting to AWS Shadow service and demonstrate a simple light bulb e..." alt="" coords="899,5,981,32"/>
<area shape="rect" title=" " alt="" coords="6,453,77,480"/>
<area shape="rect" href="mmhal_8h_source.html" title=" " alt="" coords="760,80,840,107"/>
<area shape="rect" href="mmosal_8h_source.html" title=" " alt="" coords="161,379,247,405"/>
<area shape="rect" href="mmwlan_8h_source.html" title=" " alt="" coords="259,229,349,256"/>
<area shape="rect" href="mmconfig_8h_source.html" title=" " alt="" coords="981,304,1080,331"/>
<area shape="rect" title=" " alt="" coords="1003,80,1168,107"/>
<area shape="rect" href="mmipal_8h_source.html" title=" " alt="" coords="374,379,458,405"/>
<area shape="rect" title=" " alt="" coords="1192,80,1336,107"/>
<area shape="rect" title=" " alt="" coords="1361,80,1466,107"/>
<area shape="rect" title=" " alt="" coords="1491,80,1587,107"/>
<area shape="rect" title=" " alt="" coords="1611,80,1765,107"/>
<area shape="rect" href="aws__iot__config_8h.html" title="Contains the configuration parameters for the AWS IoT application." alt="" coords="1084,155,1215,181"/>
<area shape="rect" title=" " alt="" coords="607,453,689,480"/>
<area shape="rect" title=" " alt="" coords="736,379,811,405"/>
<area shape="rect" title=" " alt="" coords="446,453,517,480"/>
<area shape="rect" title=" " alt="" coords="496,229,560,256"/>
<area shape="rect" href="mmhal__flash_8h_source.html" title=" " alt="" coords="838,304,957,331"/>
<area shape="rect" href="mmhal__wlan_8h_source.html" title=" " alt="" coords="598,155,717,181"/>
<area shape="rect" href="mmpkt_8h_source.html" title=" " alt="" coords="518,304,599,331"/>
<area shape="rect" title=" " alt="" coords="949,453,1016,480"/>
<area shape="rect" title=" " alt="" coords="101,453,171,480"/>
<area shape="rect" title=" " alt="" coords="195,453,282,480"/>
<area shape="rect" title=" " alt="" coords="245,304,320,331"/>
</map>
</div>
</div>
<p><a href="aws__iot_8c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:a1c3787e7635b7cd51fe780cd07b2642d"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a1c3787e7635b7cd51fe780cd07b2642d">NTP_MIN_TIMEOUT</a>&#160;&#160;&#160;3000</td></tr>
<tr class="memdesc:a1c3787e7635b7cd51fe780cd07b2642d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Minimum NTP timeout per attempt.  <a href="aws__iot_8c.html#a1c3787e7635b7cd51fe780cd07b2642d">More...</a><br /></td></tr>
<tr class="separator:a1c3787e7635b7cd51fe780cd07b2642d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:adbfef442866e999b24603b0dbb3a32fd"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#adbfef442866e999b24603b0dbb3a32fd">NTP_MIN_BACKOFF</a>&#160;&#160;&#160;60000</td></tr>
<tr class="memdesc:adbfef442866e999b24603b0dbb3a32fd"><td class="mdescLeft">&#160;</td><td class="mdescRight">We need to back-off at least 60 seconds or most NTP Servers will tell us to go away.  <a href="aws__iot_8c.html#adbfef442866e999b24603b0dbb3a32fd">More...</a><br /></td></tr>
<tr class="separator:adbfef442866e999b24603b0dbb3a32fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a0a258aeff42d0fa37ce86b573d9bb1e4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a0a258aeff42d0fa37ce86b573d9bb1e4">NTP_MIN_BACKOFF_JITTER</a>&#160;&#160;&#160;3000</td></tr>
<tr class="memdesc:a0a258aeff42d0fa37ce86b573d9bb1e4"><td class="mdescLeft">&#160;</td><td class="mdescRight">Minimum back-off jitter per attempt.  <a href="aws__iot_8c.html#a0a258aeff42d0fa37ce86b573d9bb1e4">More...</a><br /></td></tr>
<tr class="separator:a0a258aeff42d0fa37ce86b573d9bb1e4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:af4b9aadafaa998249f1d4c20771beea9"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#af4b9aadafaa998249f1d4c20771beea9">NTP_MAX_BACKOFF_JITTER</a>&#160;&#160;&#160;60000</td></tr>
<tr class="memdesc:af4b9aadafaa998249f1d4c20771beea9"><td class="mdescLeft">&#160;</td><td class="mdescRight">Maximum back-off jitter per attempt.  <a href="aws__iot_8c.html#af4b9aadafaa998249f1d4c20771beea9">More...</a><br /></td></tr>
<tr class="separator:af4b9aadafaa998249f1d4c20771beea9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa892f87105b17e38d6934103aefe8297"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#aa892f87105b17e38d6934103aefe8297">SHADOW_PUBLISH_JSON</a></td></tr>
<tr class="memdesc:aa892f87105b17e38d6934103aefe8297"><td class="mdescLeft">&#160;</td><td class="mdescRight">Format string representing a Shadow document with a "reported" state.  <a href="aws__iot_8c.html#aa892f87105b17e38d6934103aefe8297">More...</a><br /></td></tr>
<tr class="separator:aa892f87105b17e38d6934103aefe8297"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a73d43770c138482993be95bbcd0f02d1"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a73d43770c138482993be95bbcd0f02d1">ota_preupdate_callback</a> (void)</td></tr>
<tr class="memdesc:a73d43770c138482993be95bbcd0f02d1"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function is called when an OTA update has been triggered.  <a href="aws__iot_8c.html#a73d43770c138482993be95bbcd0f02d1">More...</a><br /></td></tr>
<tr class="separator:a73d43770c138482993be95bbcd0f02d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed0cf24358f70241e59600970b3bda71"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#aed0cf24358f70241e59600970b3bda71">ota_postupdate_callback</a> (const char *update_file, int status)</td></tr>
<tr class="memdesc:aed0cf24358f70241e59600970b3bda71"><td class="mdescLeft">&#160;</td><td class="mdescRight">This function is called after an OTA update was processed.  <a href="aws__iot_8c.html#aed0cf24358f70241e59600970b3bda71">More...</a><br /></td></tr>
<tr class="separator:aed0cf24358f70241e59600970b3bda71"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3d2444352ef7a43498b8364d31303669"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a3d2444352ef7a43498b8364d31303669">shadow_update_callback</a> (char *json, size_t json_len, enum shadow_update_status status)</td></tr>
<tr class="memdesc:a3d2444352ef7a43498b8364d31303669"><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback function invoked on shadow state updates.  <a href="aws__iot_8c.html#a3d2444352ef7a43498b8364d31303669">More...</a><br /></td></tr>
<tr class="separator:a3d2444352ef7a43498b8364d31303669"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a645a4304e63f5953522b4d14f644e00a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a645a4304e63f5953522b4d14f644e00a">aws_shadow_loop</a> (char *shadow_name)</td></tr>
<tr class="memdesc:a645a4304e63f5953522b4d14f644e00a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main shadow loop.  <a href="aws__iot_8c.html#a645a4304e63f5953522b4d14f644e00a">More...</a><br /></td></tr>
<tr class="separator:a645a4304e63f5953522b4d14f644e00a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add3190cf715f513666f4be42874d91e2"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#add3190cf715f513666f4be42874d91e2">app_init</a> (void)</td></tr>
<tr class="memdesc:add3190cf715f513666f4be42874d91e2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main entry point to the application.  <a href="aws__iot_8c.html#add3190cf715f513666f4be42874d91e2">More...</a><br /></td></tr>
<tr class="separator:add3190cf715f513666f4be42874d91e2"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="var-members" name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a26ebd1671fec1be6d6a4b32c98776395"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a26ebd1671fec1be6d6a4b32c98776395">ulCurrentPowerOnState</a> = 0</td></tr>
<tr class="memdesc:a26ebd1671fec1be6d6a4b32c98776395"><td class="mdescLeft">&#160;</td><td class="mdescRight">Current state of the lamp.  <a href="aws__iot_8c.html#a26ebd1671fec1be6d6a4b32c98776395">More...</a><br /></td></tr>
<tr class="separator:a26ebd1671fec1be6d6a4b32c98776395"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a454f6c6974c4e74e5ae8929f0b17e8a0"><td class="memItemLeft" align="right" valign="top">static uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#a454f6c6974c4e74e5ae8929f0b17e8a0">ulDesiredPowerOnState</a> = 0</td></tr>
<tr class="memdesc:a454f6c6974c4e74e5ae8929f0b17e8a0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Desired state of the lamp.  <a href="aws__iot_8c.html#a454f6c6974c4e74e5ae8929f0b17e8a0">More...</a><br /></td></tr>
<tr class="separator:a454f6c6974c4e74e5ae8929f0b17e8a0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac86b2bba201cff0b28014a4bae56d3d1"><td class="memItemLeft" align="right" valign="top">struct mmosal_sem *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="aws__iot_8c.html#ac86b2bba201cff0b28014a4bae56d3d1">state_change_sem</a> = NULL</td></tr>
<tr class="memdesc:ac86b2bba201cff0b28014a4bae56d3d1"><td class="mdescLeft">&#160;</td><td class="mdescRight">Semaphore to request change of state of the lamp.  <a href="aws__iot_8c.html#ac86b2bba201cff0b28014a4bae56d3d1">More...</a><br /></td></tr>
<tr class="separator:ac86b2bba201cff0b28014a4bae56d3d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="af4b9aadafaa998249f1d4c20771beea9" name="af4b9aadafaa998249f1d4c20771beea9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#af4b9aadafaa998249f1d4c20771beea9">&#9670;&nbsp;</a></span>NTP_MAX_BACKOFF_JITTER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_MAX_BACKOFF_JITTER&#160;&#160;&#160;60000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Maximum back-off jitter per attempt. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00528">528</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="adbfef442866e999b24603b0dbb3a32fd" name="adbfef442866e999b24603b0dbb3a32fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#adbfef442866e999b24603b0dbb3a32fd">&#9670;&nbsp;</a></span>NTP_MIN_BACKOFF</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_MIN_BACKOFF&#160;&#160;&#160;60000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>We need to back-off at least 60 seconds or most NTP Servers will tell us to go away. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00524">524</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a0a258aeff42d0fa37ce86b573d9bb1e4" name="a0a258aeff42d0fa37ce86b573d9bb1e4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0a258aeff42d0fa37ce86b573d9bb1e4">&#9670;&nbsp;</a></span>NTP_MIN_BACKOFF_JITTER</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_MIN_BACKOFF_JITTER&#160;&#160;&#160;3000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Minimum back-off jitter per attempt. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00526">526</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a1c3787e7635b7cd51fe780cd07b2642d" name="a1c3787e7635b7cd51fe780cd07b2642d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a1c3787e7635b7cd51fe780cd07b2642d">&#9670;&nbsp;</a></span>NTP_MIN_TIMEOUT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define NTP_MIN_TIMEOUT&#160;&#160;&#160;3000</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Minimum NTP timeout per attempt. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00522">522</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="aa892f87105b17e38d6934103aefe8297" name="aa892f87105b17e38d6934103aefe8297"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aa892f87105b17e38d6934103aefe8297">&#9670;&nbsp;</a></span>SHADOW_PUBLISH_JSON</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define SHADOW_PUBLISH_JSON</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    <span class="stringliteral">&quot;{&quot;</span>                                   \</div>
<div class="line">        <span class="stringliteral">&quot;\&quot;state\&quot;:{&quot;</span>                     \</div>
<div class="line">            <span class="stringliteral">&quot;\&quot;reported\&quot;:{&quot;</span>              \</div>
<div class="line">                <span class="stringliteral">&quot;\&quot;powerOn\&quot;:%lu&quot;</span>         \</div>
<div class="line">            <span class="stringliteral">&quot;}&quot;</span>                           \</div>
<div class="line">        <span class="stringliteral">&quot;},&quot;</span>                              \</div>
<div class="line">        <span class="stringliteral">&quot;\&quot;clientToken\&quot;:\&quot;%06lu\&quot;&quot;</span>       \</div>
<div class="line">    <span class="stringliteral">&quot;}&quot;</span></div>
</div><!-- fragment -->
<p>Format string representing a Shadow document with a "reported" state. </p>
<p >The real json document will look like this: </p><div class="fragment"><div class="line">{</div>
<div class="line">  <span class="stringliteral">&quot;state&quot;</span>: {</div>
<div class="line">    <span class="stringliteral">&quot;reported&quot;</span>: {</div>
<div class="line">      <span class="stringliteral">&quot;powerOn&quot;</span>: 1</div>
<div class="line">    }</div>
<div class="line">  },</div>
<div class="line">  <span class="stringliteral">&quot;clientToken&quot;</span>: <span class="stringliteral">&quot;021909&quot;</span></div>
<div class="line">}</div>
</div><!-- fragment --><p> Note the client token, which is optional. The token is used to identify the response to an update. The client token must be unique at any given time, but may be reused once the update is completed. For this demo, a timestamp is used for a client token. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00549">549</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="add3190cf715f513666f4be42874d91e2" name="add3190cf715f513666f4be42874d91e2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#add3190cf715f513666f4be42874d91e2">&#9670;&nbsp;</a></span>app_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void app_init </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main entry point to the application. </p>
<p >This will be invoked in a thread once operating system and hardware initialization has completed. It may return, but it does not have to. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00828">828</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a645a4304e63f5953522b4d14f644e00a" name="a645a4304e63f5953522b4d14f644e00a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a645a4304e63f5953522b4d14f644e00a">&#9670;&nbsp;</a></span>aws_shadow_loop()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void aws_shadow_loop </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>shadow_name</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main shadow loop. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">shadow_name</td><td>Name of the shadow. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00780">780</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="aed0cf24358f70241e59600970b3bda71" name="aed0cf24358f70241e59600970b3bda71"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed0cf24358f70241e59600970b3bda71">&#9670;&nbsp;</a></span>ota_postupdate_callback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ota_postupdate_callback </td>
          <td>(</td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>update_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&#160;</td>
          <td class="paramname"><em>status</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function is called after an OTA update was processed. </p>
<p >The application may perform any logging to note the event and also to migrate any data from the older version if required. The application may also use this callback to restore any files and data it had uploaded to the cloud prior to the update starting. This function may also be used to atomically update firmware and BCF images contained in the update file. For more information see <code>ota_postupdate_cb_fn_t</code>.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">update_file</td><td>Path to the update file - use this to update firmware or BCF if required. This file will be automatically deleted on return from this function. </td></tr>
    <tr><td class="paramname">status</td><td>0 on success, bootloader error code on failure. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00599">599</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a73d43770c138482993be95bbcd0f02d1" name="a73d43770c138482993be95bbcd0f02d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a73d43770c138482993be95bbcd0f02d1">&#9670;&nbsp;</a></span>ota_preupdate_callback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ota_preupdate_callback </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This function is called when an OTA update has been triggered. </p>
<p >The primary use case of this function is to clear up space in the file system for the OTA download. Once this function returns there should be enough space available in the file system to store the complete update image. For more information see <code>ota_preupdate_cb_fn_t</code>. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00576">576</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a3d2444352ef7a43498b8364d31303669" name="a3d2444352ef7a43498b8364d31303669"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3d2444352ef7a43498b8364d31303669">&#9670;&nbsp;</a></span>shadow_update_callback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void shadow_update_callback </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>json</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&#160;</td>
          <td class="paramname"><em>json_len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum shadow_update_status&#160;</td>
          <td class="paramname"><em>status</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Callback function invoked on shadow state updates. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">json</td><td>The JSON update message, not NULL terminated. </td></tr>
    <tr><td class="paramname">json_len</td><td>The length of the JSON update message. </td></tr>
    <tr><td class="paramname">status</td><td>The status of the update. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00620">620</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="ac86b2bba201cff0b28014a4bae56d3d1" name="ac86b2bba201cff0b28014a4bae56d3d1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac86b2bba201cff0b28014a4bae56d3d1">&#9670;&nbsp;</a></span>state_change_sem</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct mmosal_sem* state_change_sem = NULL</td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Semaphore to request change of state of the lamp. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00566">566</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a26ebd1671fec1be6d6a4b32c98776395" name="a26ebd1671fec1be6d6a4b32c98776395"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a26ebd1671fec1be6d6a4b32c98776395">&#9670;&nbsp;</a></span>ulCurrentPowerOnState</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t ulCurrentPowerOnState = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Current state of the lamp. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00560">560</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
<a id="a454f6c6974c4e74e5ae8929f0b17e8a0" name="a454f6c6974c4e74e5ae8929f0b17e8a0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a454f6c6974c4e74e5ae8929f0b17e8a0">&#9670;&nbsp;</a></span>ulDesiredPowerOnState</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t ulDesiredPowerOnState = 0</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Desired state of the lamp. </p>

<p class="definition">Definition at line <a class="el" href="aws__iot_8c_source.html#l00563">563</a> of file <a class="el" href="aws__iot_8c_source.html">aws_iot.c</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_cddc6ecb1abce9511317e8c5cc90cd4c.html">examples</a></li><li class="navelem"><a class="el" href="dir_a0ecb57ec537bb36eb2986b0b09c61df.html">aws_iot</a></li><li class="navelem"><a class="el" href="dir_a1d728a3ecab945357ff69222d59821e.html">src</a></li><li class="navelem"><a class="el" href="aws__iot_8c.html">aws_iot.c</a></li>
    <li class="footer">Copyright 2021 Morse Micro </li>
  </ul>
</div>
</body>
</html>
