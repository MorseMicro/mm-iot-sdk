<!-- HTML header for doxygen 1.8.17-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Morse Micro IoT SDK: mm-ekh08-wb55 with BLE (mm-ekh08-wb55-ble) Readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
<link rel="shortcut icon" href="favicon.svg" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Morse Micro IoT SDK
   &#160;<span id="projectnumber">2.9.7</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('MM_EKH08_WB55_BLE_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">mm-ekh08-wb55 with BLE (mm-ekh08-wb55-ble) Readme </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md__home_jenkins_agent_workspace_build_mhs_binaries_mhs_platforms_arm_cortex_m4f_mm_ekh08_wb55_ble_readme"></a></p>
<p ><b>Copyright 2023-2024 Morse Micro</b></p>
<h1><a class="anchor" id="autotoc_md127"></a>
Summary</h1>
<p >This directory contains all of the hardware dependent code needed to use a STM32 Nucleo-64 development board with STM32WB55RG MCU configured for BLE operation.</p>
<blockquote class="doxtable">
<p >&zwj;It should be noted that the provided cube.ioc is provided as a reference only. If code is regenerated using <a href="https://www.st.com/en/development-tools/stm32cubemx.html">STM32CubeMX</a> it will break the applications. This is because STM32CubeMX does not support generating BLE code with FreeRTOS. Generated using <a href="https://www.st.com/stm32cubemx">STM32CubeMX v6.6.1</a>. </p>
</blockquote>
<p>This platform is based off of the basic mm-ekh08-wb55rg platform with the addition of the [heart rate sensor demo BLE app](<a href="https://github.com/STMicroelectronics/STM32CubeWB/tree/v1.14.1/Projects/P-NUCLEO-WB55.Nucleo/Applications/BLE/BLE_HeartRateFreeRTOS">https://github.com/STMicroelectronics/STM32CubeWB/tree/v1.14.1/Projects/P-NUCLEO-WB55.Nucleo/Applications/BLE/BLE_HeartRateFreeRTOS</a>) provided by ST. It is meant to serve as a reference for running BLE &amp; MM-IOT-SDK stack concurrently. We have taken care to minimize the changes to make view the diff to both the ST application and our non-BLE mm-ekh08-wb55rg platform possible.</p>
<p >The source for all the ST provided code is taken from the <a href="https://github.com/STMicroelectronics/STM32CubeWB">STM32CubeWB v1.14.1</a> repository</p>
<h2><a class="anchor" id="WB55BLE_Recommended_Reading"></a>
Recommended Reading</h2>
<p >It is highly recommended to read the following application notes provided by ST before developing on this platform.</p>
<h3><a class="anchor" id="autotoc_md128"></a>
General Documents</h3>
<p >These are useful as a reference for the general operation of the MCU.</p><ul>
<li><a href="https://www.st.com/resource/en/reference_manual/rm0434-multiprotocol-wireless-32bit-mcu-armbased-cortexm4-with-fpu-bluetooth-lowenergy-and-802154-radio-solution-stmicroelectronics.pdf">RM-434 Reference Manual</a></li>
<li><a href="https://www.st.com/resource/en/datasheet/stm32wb55cc.pdf">Datasheet</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md129"></a>
BLE Specific Documents</h2>
<p >These documents go over the BLE portions of the MCU in greater detail.</p><ul>
<li><a href="https://www.st.com/resource/en/application_note/an5289-building-wireless-applications-with-stm32wb-series-mcus-stmicroelectronics.pdf">Building wireless applications with STM32WB Series microcontrollers - AN5289</a></li>
<li><a href="https://www.st.com/resource/en/programming_manual/pm0271-guidelines-for-bluetooth-low-energy-stack-programming-on-stm32wb-stm32wba-mcus-stmicroelectronics.pdf">Guidelines for Bluetooth® Low Energy stack programming on STM32WB/STM32WBA MCUs - PM0271</a></li>
<li><a href="https://www.st.com/resource/en/application_note/an5185-st-firmware-upgrade-services-for-stm32wb-series-stmicroelectronics.pdf">ST firmware upgrade services for STM32WB Series - AN5185</a></li>
<li><a href="https://www.st.com/resource/en/application_note/an5270-stm32wb-bluetooth-low-energy-wireless-interface-stmicroelectronics.pdf">STM32WB Bluetooth® Low Energy wireless interface - AN5270</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md130"></a>
Board Support Package (BSP) directory overview</h2>
<h3><a class="anchor" id="autotoc_md131"></a>
Core</h3>
<p >The <code>Core</code> directory contains all of the setup and configuration code for the board. This will need to be modified to select and provide initialization endpoints for the peripherals. The following files are modified slightly for the BLE application but serve a similar purpose to the non-BLE BSP.</p>
<ul>
<li>Core/Inc/stm32wbxx_hal_conf.h HAL configuration file</li>
<li>Core/Inc/stm32wbxx_it.h Interrupt handlers header file</li>
<li>Core/Inc/main.h Header for main.c module</li>
<li>Core/Src/stm32wbxx_it.c Interrupt handlers</li>
<li>Core/Src/main.c Main program</li>
<li>Core/Src/system_stm32wbxx.c stm32wbxx system source file</li>
</ul>
<h4><a class="anchor" id="autotoc_md132"></a>
BLE Specific files</h4>
<p >These are all files included specifically for the BLE portion of the application. Care should be taken when modifying defines as not all will work but have been left in to make running a diff with the reference application easier.</p>
<ul>
<li>Core/Inc/app_common.h Header for all modules with common definition</li>
<li>Core/Inc/app_conf.h Parameters configuration file of the application</li>
<li>Core/Inc/app_entry.h Parameters configuration file of the application</li>
<li>Core/Inc/hw_conf.h Configuration file of the HW</li>
<li>Core/Inc/utilities_conf.h Configuration file of the utilities</li>
<li>Core/Src/app_entry.c Initialization of the application</li>
<li>Core/Src/stm32_lpm_if.c Low Power Manager Interface</li>
<li>Core/Src/hw_timerserver.c Timer Server based on RTC</li>
<li>Core/Src/hw_uart.c UART Driver</li>
</ul>
<h3><a class="anchor" id="autotoc_md133"></a>
STM32_WPAN</h3>
<p >This directory contains all the logic for running the BLE application.</p>
<ul>
<li>STM32_WPAN/App/app_ble.h Header for app_ble.c module</li>
<li>STM32_WPAN/App/ble_conf.h BLE Services configuration</li>
<li>STM32_WPAN/App/ble_dbg_conf.h BLE Traces configuration of the BLE services</li>
<li>STM32_WPAN/App/dis_app.h Header for dis_app.c module</li>
<li>STM32_WPAN/App/hrs_app.h Header for hrs_app.c module</li>
<li>STM32_WPAN/App/app_ble.c BLE Profile implementation</li>
<li>STM32_WPAN/App/dis_app.c Device Information Service application</li>
<li>STM32_WPAN/App/hrs_app.c Heart Rate Service application</li>
<li>STM32_WPAN/Target/hw_ipcc.c IPCC Driver</li>
</ul>
<h3><a class="anchor" id="autotoc_md134"></a>
mm_shims</h3>
<p >The files in the <code>mm_shims</code> directory (<code>mmhal.c</code>, <code>mmport.h</code>, <code>wlan_hal.c</code>) are where the board specific API functions used by morselib are implemented.</p>
<h2><a class="anchor" id="autotoc_md135"></a>
Getting the BLE Stack running</h2>
<p >This is a very basic overview on how to get the BLE stack running. It is highly recommend to review the documents in the <a class="el" href="MM_EKH08_WB55_BLE_README.html#WB55BLE_Recommended_Reading">Recommended Reading</a> section for more details.</p>
<p >As an overview the STM32WB55RG has two CPU cores.</p>
<ul>
<li>CPU1 (ARM Cortex M4) is where the application code that we write will run.</li>
<li>CPU2 (ARM Cortex M0+) is responsible for the BLE stack provided by ST. This is referred to as the wireless coprocessor.</li>
</ul>
<h3><a class="anchor" id="autotoc_md136"></a>
Loading the code.</h3>
<p >For BLE operation ST has provided a number of pre-compiled binaries. For this example platform the <code>stm32wb5x_BLE_Stack_light_fw.bin</code> binary has been used to minimize the amount of flash memory that it uses. This binary is loaded in to the bottom portion of the flash using the firmware upgrade services (FUS) available on STM32WB series MCUs. Instructions on how to load this can be found in the <a href="https://github.com/STMicroelectronics/STM32CubeWB/blob/v1.14.1/Projects/STM32WB_Copro_Wireless_Binaries/STM32WB5x/Release_Notes.html">releases notes</a> for the coprocessor binaries. We provide a local copy on the necessary files here <code>bsps/stm32cubewb/Projects/STM32WB_Copro_Wireless_Binaries/STM32WB5x/</code></p>
<p >Before loading the co-processor binary please ensure that you have the latest FUS FW version installed, currently <code>v1.2.0</code>. Install steps for this can also be found in the release notes. If this is not done first it will wipe the co-processor binary.</p>
<blockquote class="doxtable">
<p >&zwj;The provided linker script has been configured to leave enough space for the <code>stm32wb5x_BLE_Stack_light_fw.bin</code> binary. If you wish to use another binary this will need to be adjusted. </p>
</blockquote>
<p>Once the wireless coprocessor binary has been loaded using the steps provided by ST the example applications can be loaded on as per the usual steps. Note that the wireless coprocessor binary only needs to be loaded once.</p>
<h3><a class="anchor" id="autotoc_md137"></a>
Running the code</h3>
<p >Once the code has been load and starts running the applications will behave as per the other platform. The BLE processes will have their own threads in the background that will handle running the Heart Rate Monitor application.</p>
<p >For the BLE we can follow the steps provided by ST, <a href="https://github.com/STMicroelectronics/STM32CubeWB/blob/v1.14.1/Projects/P-NUCLEO-WB55.Nucleo/Applications/BLE/BLE_HeartRateFreeRTOS/readme.txt">Heart Rate Readme</a>.</p>
<p >On the android/ios device, enable the Bluetooth communications, and if not done before,</p>
<ul>
<li>Install the ST BLE Sensor application on the ios/android device<ul>
<li><a href="https://play.google.com/store/apps/details?id=com.st.bluems&hl=en&gl=US&pli=1">https://play.google.com/store/apps/details?id=com.st.bluems&amp;hl=en&amp;gl=US&amp;pli=1</a></li>
<li><a href="https://apps.apple.com/us/app/st-ble-sensor/id993670214">https://apps.apple.com/us/app/st-ble-sensor/id993670214</a></li>
</ul>
</li>
<li>Power on the Nucleo board with the application</li>
<li>Then, click on the App icon, ST BLE Sensor</li>
<li>Connect to a device</li>
<li>Select the HRSTM in the device list</li>
</ul>
<p >You should now see a simulated heart beat value updating every 1 second.</p>
<h3><a class="anchor" id="autotoc_md138"></a>
Debug Messages</h3>
<p >The debug infrastructure provided by ST for the BLE module is not compatible with the rest of the MM-IoT-SDK without significant changes. As stated above this has been left in to enabled easy comparisons to the ST application.</p>
<p >That being said we have provided a method of printing the BLE debug messages. If you comment out the define provided in <code>Core/Inc/app_conf.h</code> you will see the debug messages printed out the UART. </p><pre class="fragment">/* Comment out the below line to enable debug logging for BLE */
// #define APP_DBG_MSG(...)        do{printf("[%s]", "BLE");printf(__VA_ARGS__);}while(0);
</pre> <h2><a class="anchor" id="autotoc_md139"></a>
Pinout MMECH08</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">MM6108 pin   </th><th class="markdownTableHeadNone">Nucleo/Arduino header pin   </th><th class="markdownTableHeadNone">STM32WB55 pin    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">RESET_N   </td><td class="markdownTableBodyNone">A0   </td><td class="markdownTableBodyNone">PC0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">WAKE   </td><td class="markdownTableBodyNone">A1   </td><td class="markdownTableBodyNone">PC1    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">BUSY   </td><td class="markdownTableBodyNone">A2   </td><td class="markdownTableBodyNone">PA1    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SPI_SCK   </td><td class="markdownTableBodyNone">SCK   </td><td class="markdownTableBodyNone">PA5    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SPI_MOSI   </td><td class="markdownTableBodyNone">MOSI   </td><td class="markdownTableBodyNone">PA7    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SPI_MISO   </td><td class="markdownTableBodyNone">MISO   </td><td class="markdownTableBodyNone">PA6    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SPI_CS   </td><td class="markdownTableBodyNone">CS   </td><td class="markdownTableBodyNone">PA4    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SPI_IRQ   </td><td class="markdownTableBodyNone">A4   </td><td class="markdownTableBodyNone">PC3   </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.17-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="MMPLATFORMS.html">Morse Micro IoT Reference Platforms</a></li>
    <li class="footer">Copyright 2021 Morse Micro </li>
  </ul>
</div>
</body>
</html>
